<%- include('../partials/header') %>
<link rel="stylesheet" href="/css/main.css">

<div class="main-content">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h1 class="h3 mb-0">แดชบอร์ดผู้ดูแลระบบ</h1>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-12 col-sm-6 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">จำนวนชมรม</div>
            <div class="fs-3 fw-bold"><%= totalClubs %></div>
          </div>
          <i class="bi bi-collection fs-1 text-primary"></i>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">สมาชิกทั้งหมด</div>
            <div class="fs-3 fw-bold"><%= totalMembers %></div>
          </div>
          <i class="bi bi-people fs-1 text-success"></i>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">การจองสถานที่ทั้งหมด</div>
            <div class="fs-3 fw-bold"><%= totalBookings %></div>
          </div>
          <i class="bi bi-calendar-check fs-1 text-warning"></i>
        </div>
      </div>
    </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-12 col-sm-6 col-lg-4">
    <div class="card shadow-sm">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted">หัวหน้าชมรม</div>
          <div class="fs-3 fw-bold"><%= totalLeaders %></div>
        </div>
        <i class="bi bi-person-badge fs-1 text-info"></i>
      </div>
    </div>
  </div>
  <div class="col-12 col-sm-6 col-lg-4">
    <div class="card shadow-sm">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted">กิจกรรมทั้งหมด</div>
          <div class="fs-3 fw-bold"><%= totalEvents %></div>
        </div>
        <i class="bi bi-activity fs-1 text-danger"></i>
      </div>
    </div>
  </div>
  <div class="col-12 col-sm-6 col-lg-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div class="text-muted">ห้องใช้งาน/ห้องว่าง</div>
          <div><span class="badge bg-secondary me-1"><%= usedRooms %></span><span class="badge bg-success"><%= availableRooms %></span></div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">จำนวนสมาชิกต่อชมรม (Top 10)</h5>
          <canvas id="membersPerClub" style="height:300px;"></canvas>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">จำนวนกิจกรรมต่อชมรม (Top 10)</h5>
          <canvas id="eventsPerClub" style="height:300px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mt-3">
    <div class="card-body">
      <h5 class="mb-3">อัตราการใช้ห้อง/เดือน (ประมาณการ)</h5>
      <canvas id="monthlyUsage"></canvas>
    </div>
  </div>

  <div class="card shadow-sm mt-3">
    <div class="card-body">
      <h5 class="mb-3">การแจ้งเตือนล่าสุด</h5>
      <% if (!recentNotifications || recentNotifications.length === 0) { %>
        <div class="text-muted">ไม่มีการแจ้งเตือน</div>
      <% } else { %>
        <ul class="list-group">
          <% recentNotifications.forEach(n => { %>
            <li class="list-group-item d-flex justify-content-between align-items-center <%= n.is_read ? '' : 'bg-light' %>">
              <span><%= n.message %></span>
              <small class="text-muted"><%= new Date(n.created_at).toLocaleString() %></small>
            </li>
          <% }) %>
        </ul>
      <% } %>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function(){
    var mLabels = JSON.parse('<%- JSON.stringify(membersPerClubLabels || []) %>');
    var mData = JSON.parse('<%- JSON.stringify(membersPerClubData || []) %>');
    var eLabels = JSON.parse('<%- JSON.stringify(eventsPerClubLabels || []) %>');
    var eData = JSON.parse('<%- JSON.stringify(eventsPerClubData || []) %>');
    var uLabels = JSON.parse('<%- JSON.stringify(usageLabels || []) %>');
    var uPercents = JSON.parse('<%- JSON.stringify(usagePercents || []) %>');

    var ctx1 = document.getElementById('membersPerClub');
    if (ctx1) {
      new Chart(ctx1, { type: 'bar', data: { labels: mLabels, datasets: [{ label: 'สมาชิก', data: mData, backgroundColor: '#0d6efd' }] }, options: { responsive: true, maintainAspectRatio: false } });
    }
    var ctx2 = document.getElementById('eventsPerClub');
    if (ctx2) {
      new Chart(ctx2, { type: 'bar', data: { labels: eLabels, datasets: [{ label: 'กิจกรรม', data: eData, backgroundColor: '#dc3545' }] }, options: { responsive: true, maintainAspectRatio: false } });
    }
    var ctx3 = document.getElementById('monthlyUsage');
    if (ctx3) {
      new Chart(ctx3, { type: 'line', data: { labels: uLabels, datasets: [{ label: '% การใช้ห้อง', data: uPercents, borderColor: '#198754', tension: .2 }] }, options: { scales: { y: { min: 0, max: 100 } } } });
    }
  })();
</script>
