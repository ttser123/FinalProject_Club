<!-- Bootstrap 5 CSS และ Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/partials/header.css">

<header class="topbar">
  <div class="topbar-left">
    <a href="/index" class="brand">
      <img src="/images/logo.png" alt="Logo" class="brand-logo">
      <span class="brand-name">Club Management</span>
    </a>
  </div>

  <div class="topbar-center">
    <% if (user) { %>
      <nav class="topbar-secondary">
        <ul class="topbar-menu">
          <% if (user.role === 'admin' || !isClubMember) { %>
            <li><a href="/index"><i class="bi bi-calendar-event"></i> ชมรมทั้งหมด</a></li>
          <% } %>
          <% if (user.role !== 'admin') { %>
            <li><a href="/posts"><i class="bi bi-journal-check"></i> ชมรมของฉัน</a></li>
          <% } %>
          <% if (user.role === 'leader') { %>
            <li><a href="/booking"><i class="bi bi-calendar-check"></i> จองสถานที่</a></li>
          <% } %>
          <% if (user.role === 'admin') { %>
            <li><a href="/posts/add"><i class="bi bi-plus-circle"></i> สร้างชมรม</a></li>
          <% } %>
          <li><a href="/events"><i class="bi bi-activity"></i> กิจกรรม</a></li>
          <li><a href="/dashboard"><i class="bi bi-house-door"></i> แดชบอร์ด</a></li>
          <li><a href="/settings"><i class="bi bi-gear"></i> ตั้งค่า</a></li>
        </ul>
      </nav>
    <% } %>
  </div>

  <div class="topbar-right">
    <% if (user) { %>
      <button class="btn btn-link d-lg-none" id="mobileMenuToggle" aria-label="เมนู">
        <i class="bi bi-list" style="font-size:1.4rem"></i>
      </button>

      <div class="dropdown d-inline-block me-2">
        <a href="#" class="topbar-icon position-relative dropdown-toggle" id="notifDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="การแจ้งเตือน">
          <i class="bi bi-bell"></i>
          <% if (typeof unreadCount !== 'undefined' && unreadCount > 0) { %>
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem; padding: 0.2em 0.4em;">
              <%= unreadCount %>
            </span>
          <% } %>
        </a>
        <div class="dropdown-menu dropdown-menu-end p-0" aria-labelledby="notifDropdown" style="min-width: 320px;">
          <div class="p-2 border-bottom d-flex justify-content-between align-items-center">
            <strong>การแจ้งเตือน</strong>
            <form action="/notifications/api/notifications/mark-all-read" method="POST" class="notif-mark-all">
              <button type="submit" class="btn btn-sm btn-link">ทำเครื่องหมายว่าอ่านทั้งหมด</button>
            </form>
          </div>
          <div class="list-group list-group-flush" style="max-height: 360px; overflow:auto;">
            <% if (notifications && notifications.length) { %>
              <% notifications.forEach(function(n) { %>
                <div class="list-group-item d-flex justify-content-between align-items-start <%= n.is_read ? '' : 'bg-light' %>" data-notif-id="<%= n.id %>">
                  <div class="me-2" style="white-space: normal;">
                    <div><%= n.message %></div>
                    <small class="text-muted"><%= new Date(n.created_at).toLocaleString() %></small>
                  </div>
                  <% if (!n.is_read) { %>
                    <form action="/notifications/api/notifications/<%= n.id %>/read" method="POST" class="notif-mark-one">
                      <button type="submit" class="btn btn-sm btn-outline-primary">อ่าน</button>
                    </form>
                  <% } %>
                </div>
              <% }) %>
            <% } else { %>
              <div class="list-group-item text-center text-muted">ไม่มีการแจ้งเตือน</div>
            <% } %>
          </div>
          <div class="p-2 border-top text-center">
            <a href="/notifications">ดูทั้งหมด</a>
          </div>
        </div>
      </div>

      <div class="profile">
        <i class="bi bi-person-circle"></i>
        <span class="profile-name"><%= user.f_name %></span>
      </div>

      <a href="/auth/logout" class="text-danger ms-2"><i class="bi bi-box-arrow-left"></i> Logout</a>
    <% } %>
  </div>
</header>

<!-- Mobile Menu -->
<% if (user) { %>
<div class="mobile-menu" id="mobileMenu" hidden>
  <ul>
    <% if (user.role === 'admin' || !isClubMember) { %>
      <li><a href="/index"><i class="bi bi-calendar-event"></i> ชมรมทั้งหมด</a></li>
    <% } %>
    <% if (user.role !== 'admin') { %>
      <li><a href="/posts"><i class="bi bi-journal-check"></i> ชมรมของฉัน</a></li>
    <% } %>
    <% if (user.role === 'leader') { %>
      <li><a href="/booking"><i class="bi bi-calendar-check"></i> จองสถานที่</a></li>
    <% } %>
    <% if (user.role === 'admin') { %>
      <li><a href="/posts/add"><i class="bi bi-plus-circle"></i> สร้างชมรม</a></li>
    <% } %>
    <li><a href="/events"><i class="bi bi-activity"></i> กิจกรรม</a></li>
    <li><a href="/dashboard"><i class="bi bi-house-door"></i> แดชบอร์ด</a></li>
    <li><a href="/settings"><i class="bi bi-gear"></i> ตั้งค่า</a></li>
    <li><a href="/auth/logout" class="text-danger"><i class="bi bi-box-arrow-left"></i> Logout</a></li>
  </ul>
  <div class="backdrop" id="mobileMenuBackdrop"></div>
</div>
<% } %>

<script>
  (function(){
    var btn = document.getElementById('mobileMenuToggle');
    var menu = document.getElementById('mobileMenu');
    var backdrop = document.getElementById('mobileMenuBackdrop');

    if (btn && menu) {
      btn.addEventListener('click', function(){
        var isHidden = menu.hasAttribute('hidden');
        menu.toggleAttribute('hidden', !isHidden);
      });
    }

    if (backdrop) {
      backdrop.addEventListener('click', function(){ menu && menu.setAttribute('hidden',''); });
    }

    var links = menu ? menu.querySelectorAll('a') : [];
    links.forEach(function(a){ a.addEventListener('click', function(){ menu.setAttribute('hidden',''); }); });

    document.addEventListener('keydown', function(e){ if (e.key === 'Escape') { menu && menu.setAttribute('hidden',''); } });
    window.addEventListener('resize', function(){ if (window.innerWidth >= 992) { menu && menu.setAttribute('hidden',''); } });
  })();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (function(){
    function updateBadge(count){
      var dropdown = document.getElementById('notifDropdown');
      if (!dropdown) return;
      var badge = dropdown.querySelector('.badge');
      if (count > 0) {
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger';
          badge.style.fontSize = '0.6rem';
          badge.style.padding = '0.2em 0.4em';
          dropdown.appendChild(badge);
        }
        badge.textContent = count;
      } else if (badge) {
        badge.remove();
      }
    }

    function handleSubmitAjax(form, onSuccess){
      form.addEventListener('submit', function(e){
        e.preventDefault();
        fetch(form.action, { method: 'POST', credentials: 'same-origin' })
          .then(function(r){ return r.json(); })
          .then(function(data){ if (onSuccess) onSuccess(data); })
          .catch(function(){ /* no-op */ });
      });
    }

    // Mark all as read
    var markAll = document.querySelector('.notif-mark-all');
    if (markAll) {
      handleSubmitAjax(markAll, function(data){ updateBadge(data && data.unreadCount ? data.unreadCount : 0); });
    }

    // Mark one as read
    document.querySelectorAll('.notif-mark-one').forEach(function(form){
      handleSubmitAjax(form, function(data){
        var item = form.closest('[data-notif-id]');
        if (item) item.classList.remove('bg-light');
        updateBadge(data && data.unreadCount ? data.unreadCount : 0);
        // hide the button after read
        form.remove();
      });
    });
  })();
  </script>
